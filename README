== java-u2flib-server
Server-side https://developers.yubico.com/U2F[U2F] library for Java. Provides functionality for registering
U2F devices and authenticate with said devices.

=== Dependency
[source, xml]
 <dependency>
   <groupId>com.yubico</groupId>
   <artifactId>u2flib-server-core</artifactId>
   <version>0.12.1</version>
 </dependency>

=== Example Usage
IMPORTANT: Make sure that you have read https://developers.yubico.com/U2F/Libraries/Using_a_library.html[Using a U2F library] before continuing.

[source, java]
----
@GET
public View startAuthentication(String username) throws U2fException {

    // Generate a challenge for each U2F device that this user has registered
    AuthenticateRequestData requestData
        = u2f.startAuthentication(SERVER_ADDRESS, getRegistrations(username));

    // Store the challenges for future reference
    requestStorage.put(requestData.getRequestId(), requestData.toJson());

    // Return an HTML page containing the challenges
    return new AuthenticationView(requestData.toJson(), username);
}

@POST
public String finishAuthentication(AuthenticateResponse response, String username)
        throws U2fException {

    // Get the challenges that we stored when starting the authentication
    AuthenticateRequestData authenticateRequest
        = requestStorage.remove(authenticateResponse.getRequestId());

    // Verify the that the given response is valid for one of the registered devices
    u2f.finishAuthentication(authenticateRequest,
                             authenticateResponse, 
                             getRegistrations(username));

    return "Successfully authenticated!";
}
----

See link:u2flib-server-demo[`u2flib-server-demo`] for a complete demo server (including registration of U2F devices).

=== JavaDoc
JavaDoc can be found at https://developers.yubico.com/java-u2flib-server[developers.yubico.com/java-u2flib-server].

=== Storing data

==== Register and Authenticate Requests

A RegisterRequest and its corresponding RegisterResponse shares a common _request ID_ (same goes for AuthenticateRequest and AuthenticateResponses). Thus, the request ID could well be used as a key when storing these objects:

[source, java]
----
RegisterRequest registerRequest = U2F.startRegistration(...);
temporaryStorage.put(registerRequest.getRequestId(), registerRequest.toJson());
----


==== Device Registration

DeviceRegistrations are typically tied to users:

[source, java]
----
RegisterRequest registerRequest = U2F.finishRegistration(...);
persistentStorage.put(user, registerRequest.toJson());
----

NOTE: All relevant classes implements `Serializable`, so instead of using `toJson()`, you can use Java's built in serialization mechanism.

=== Advanced topics

==== Verifying attestation certificates.
Attestation certificates can be verified like this:

[source,java]
----
DeviceRegistration registration =
	U2F.finishRegistration(request, response);
registration.getAttestationCertificate().verify(VENDOR_CA);
----
